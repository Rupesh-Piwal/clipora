# Snap-cut - Detailed User Flows

This document details the user's journey through the application, describing actions, UI responses, and underlying processes based on the current implementation.

## 1. Recording Flow

| User Action                                      | UI Response                                                                                                                                                             | State Changes (FSM)           | Background Tasks / System Logic                                                                                                                                                                                                                                                                 |
| :----------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1. Access Recorder**                           | The recorder interface (`RecorderView`) loads. Previews for camera and screen appear if permissions are granted.                                                         | `status: 'idle'`              | `usePiPRecording` hook initializes. `useStreams` requests initial permissions and sets up MediaStreams. `usePreviewRenderer` starts the canvas render loop.                                                                                                                                    |
| **2. Toggle Camera/Mic**                         | The corresponding preview (camera) or indicator (mic level) updates.                                                                                                    | `cameraEnabled`, `micEnabled` | `toggleCamera` or `toggleMic` from `useStreams` updates the active tracks. `useMicLevel` hook starts/stops the AudioWorklet for loudness tracking.                                                                                                                                             |
| **3. Click "Start Recording"**                   | 1. A countdown (3...2...1) appears on the screen. <br> 2. The UI enters a focused recording state.                                                                      | `status: 'initializing'`      | `startRecordingFn` initiates a timer. If cancelled before completion, it reverts to idle.                                                                                                                                                                                                       |
| **4. Recording Starts**                          | Countdown disappears. A recording timer begins. The "Start" button changes to "Stop".                                                                                   | `status: 'recording'`         | 1. **Audio Mixing:** `AudioContext` mixes mic and system audio. <br> 2. **Visual Mixing:** `CanvasRenderer` worker processes screen/webcam bitmaps at 30fps. <br> 3. **Capture:** `MediaRecorder` starts capturing the mixed stream.                                                            |
| **5. Stop Recording** (clicks "Stop Recording") | 1. A "Processing..." overlay (`LoadingView`) appears briefly. <br> 2. The UI transitions to the `ReviewView` showing the recorded video.                               | `status: 'completed'`         | 1. `MediaRecorder` is stopped. <br> 2. The recorded data chunks are compiled into a `Blob`. <br> 3. `URL.createObjectURL` is called to provide a local playback URL. <br> 4. All active media streams (camera, screen, mic) are stopped to release hardware.                                     |

## 2. Review & Upload Flow

| User Action                                             | UI Response                                                                                                                             | State Changes (Review)        | Background Tasks / System Logic                                                                                                                                                                                                                                                                 |
| :------------------------------------------------------ | :-------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1. Review Video**                                     | The recorded video plays in the `ReviewView`. User can add a description and links.                                                     | `reviewState: 'review'`       | The `<video>` element loads the local blob URL. Inputs for description and links are managed in the `ScreenRecorder` component state.                                                                                                                                                           |
| **2. Click "Upload & Share"**                           | 1. An upload progress bar appears. <br> 2. UI disables inputs to prevent modification during upload.                                    | `reviewState: 'uploading'`    | 1. **Presigning:** App calls `/api/uploads/presign` to get a S3 PUT URL and a unique `videoId`. <br> 2. **Transfer:** `uploadToS3` uses `XMLHttpRequest` to stream the blob to S3, reporting progress via `onprogress` events.                                                                  |
| **3. Upload Completes**                                 | A success screen appears with a shareable URL (e.g., `/v/[videoId]`) and a "Copy Link" button.                                          | `reviewState: 'success'`      | 1. **Metadata:** After S3 confirms upload, `saveVideoMetadata` sends the description and links to `/api/videos` to be stored in the database. <br> 2. **Link Gen:** The final shareable URL is constructed using `window.location.origin`.                                                      |
| **4. Discard Recording** (clicks "Discard" then confirm) | The app resets to the initial recording state. Any local blobs are cleaned up.                                                          | `status: 'idle'`              | 1. `resetRecording` clears the FSM and state. <br> 2. `URL.revokeObjectURL` should be called (if implemented) to free memory. <br> 3. All review-related state (description, links) is cleared.                                                                                                  |

## 3. Sharing & Viewing Flow

| User Action                                             | UI Response                                                                                                                             | State Changes                 | Background Tasks / System Logic                                                                                                                                                                                                                                                                 |
| :------------------------------------------------------ | :-------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1. Open Shared Link**                                 | The `VideoSharePage` loads. <br> - Video player is at the center. <br> - Sidebar shows description and preview cards for related links. | (Server-side rendering)       | 1. **Data Fetching:** Next.js server fetches video record and attached links from the database via Drizzle ORM. <br> 2. **S3 Auth:** Server generates a time-limited presigned GET URL for the video file using `getPresignedVideoUrl`.                                                         |
| **2. Play Video**                                       | The video streams directly from S3.                                                                                                     | `playing: true` (Player state)| The `VideoPlayer` component handles the streaming source.                                                                                                                                                                                                                                       |
| **3. Click Related Link**                               | Navigates to the external resource in a new tab.                                                                                        | -                             | Preview images for links are either retrieved from the metadata (if scraped during save) or shown as a default icon.                                                                                                                                                                            |
